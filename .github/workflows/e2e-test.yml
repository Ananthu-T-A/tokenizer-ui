name: E2E Screenshot Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  e2e-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Install backend dependencies
      run: |
        cd backend
        ~/.cargo/bin/uv sync

    - name: Start backend server
      run: |
        cd backend
        ~/.cargo/bin/uv run python main.py &
        echo $! > backend.pid
        # Wait for server to start
        for i in {1..30}; do
          if curl -s http://localhost:8000/ > /dev/null; then
            echo "Backend started successfully"
            break
          fi
          echo "Waiting for backend to start... ($i/30)"
          sleep 2
        done

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Node dependencies
      run: npm install

    - name: Start frontend server
      run: |
        python3 -m http.server 8080 &
        echo $! > frontend.pid
        sleep 2

    - name: Create test output directory
      run: mkdir -p test-output

    - name: Run E2E tests
      run: npm run test:e2e

    - name: Upload screenshots as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-screenshots
        path: test-output/*.png
        retention-days: 30

    - name: Stop servers
      if: always()
      run: |
        if [ -f backend.pid ]; then kill $(cat backend.pid) || true; fi
        if [ -f frontend.pid ]; then kill $(cat frontend.pid) || true; fi
